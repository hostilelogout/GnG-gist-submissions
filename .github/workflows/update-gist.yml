name: Update Staff Gist

on:
  issues:
    types: [closed]

jobs:
  update:
    if: contains(github.event.issue.labels.*.name, 'gist-request')
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Extract data from the closed issue
      - name: Extract data from issue
        id: extract
        run: |
          BODY="${{ github.event.issue.body }}"
          ACTION=$(echo "$BODY" | grep -i "Action" -A1 | tail -n1 | tr -d '\r')
          NAME=$(echo "$BODY" | grep -i "Staff name" -A1 | tail -n1 | tr -d '\r')
          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT

      # 2️⃣ Download the current Gist file
      - name: Download current Gist
        run: |
          curl -s -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            https://api.github.com/gists/9b98e6a25159cb400fc313426839c1bf \
            | jq -r '.files["GnG Currrent Staff"].content' > staff.txt

      # 3️⃣ Ensure file ends with a newline
      - name: Ensure newline at end
        run: |
          sed -i -e '$a\' staff.txt

      # 4️⃣ Add or remove the staff name
      - name: Modify staff list
        run: |
          NAME=$(echo "${{ steps.extract.outputs.name }}" | tr -d '\r')
          ACTION=$(echo "${{ steps.extract.outputs.action }}" | tr -d '\r')

          if [ "$ACTION" = "Add" ]; then
            grep -Fxq "$NAME" staff.txt || echo "$NAME" >> staff.txt
          elif [ "$ACTION" = "Remove" ]; then
            grep -Fxv "$NAME" staff.txt > temp.txt
            mv temp.txt staff.txt
          fi

      # 5️⃣ Update the Gist safely (fixed)
      - name: Update Gist
        run: |
          # Create a safe JSON payload
          jq -n --arg content "$(cat staff.txt)" \
            '{"files": {"GnG Currrent Staff": {"content": $content}}}' > payload.json

          # Send the update via GitHub API
          curl -s -X PATCH https://api.github.com/gists/9b98e6a25159cb400fc313426839c1bf \
            -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -d @payload.json
