name: Update Staff Gist

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Select Add or Remove'
        required: true
        type: choice
        options:
          - Add
          - Remove
      name:
        description: 'Staff Name exactly as it should appear'
        required: true

jobs:
  update-gist:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Download current Gist
      - name: Download current Gist
        run: |
          curl -s -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            https://api.github.com/gists/9b98e6a25159cb400fc313426839c1bf \
            | jq -r '.files["GnG Currrent Staff"].content' > staff.txt

      # 2️⃣ Remove trailing blank lines (but keep each line intact)
      - name: Remove trailing empty lines
        run: |
          sed -i '/^[[:space:]]*$/d' staff.txt || true

      # 3️⃣ Add or remove staff
      - name: Modify staff list
        run: |
          NAME="${{ github.event.inputs.name }}"
          ACTION="${{ github.event.inputs.action }}"

          if [ "$ACTION" = "Add" ]; then
            # Only append if not already in the file
            if ! grep -Fxq "$NAME" staff.txt; then
              # Ensure appended name starts on a new line
              [ -s staff.txt ] && printf "\n%s" "$NAME" >> staff.txt || printf "%s" "$NAME" >> staff.txt
            fi
          elif [ "$ACTION" = "Remove" ]; then
            grep -Fxv "$NAME" staff.txt > temp.txt
            mv temp.txt staff.txt
          fi

      # 4️⃣ Update the Gist
      - name: Update Gist
        run: |
          CONTENT=$(jq -Rs . < staff.txt)
          curl -s -X PATCH https://api.github.com/gists/9b98e6a25159cb400fc313426839c1bf \
            -H "Authorization: token ${{ secrets.GIST_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"files\":{\"GnG Currrent Staff\":{\"content\":$CONTENT}}}"

      # 5️⃣ Optional confirmation comment
      - name: Comment on issue
        if: ${{ github.event.issue.number != '' }}
        run: |
          curl -s -X POST https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"body\":\"Staff list updated: $ACTION $NAME ✅\"}"
